image: node:8.11.0

cache:
  untracked: true
  key: "PIPELINE-GOALIFY-CHAT-UBUNTU-V4"
  paths:
    - "$HOME/node_modules"
    - "$HOME/.meteor"
    - "$HOME/.npm"
    - "$HOME/.node-gyp"
    - "$HOME/build/RocketChat/Rocket.Chat/node_modules"
    - "$HOME/build/RocketChat/Rocket.Chat/.meteor/local"
    - "$HOME/build/RocketChat/Rocket.Chat/packages/rocketchat-livechat/.npm"
    - "$HOME/build/RocketChat/Rocket.Chat/packages/rocketchat-livechat/.app/node_modules"
    - "$HOME/build/RocketChat/Rocket.Chat/packages/rocketchat-livechat/.app/.meteor/local"

before_script:
  # prepare needed software
  - apt-get update -y
  - apt-get install -y python git openssh-client curl build-essential
  - npm i -g npm
  - node -v
  - npm -v
  - export METEOR_ALLOW_SUPERUSER=true

stages:
 - test
 - build
 - deploy

test_job:
  stage: test
  only:
    - develop
  script:
    - npm install
    - npm run lint
    - npm run testunit
    - npm run stylelint

build_job:
  stage: build
  only:
    - goalify
    - test-gitlab-ci
  script:
    # Install meteor VM
    - if [ ! -e "$HOME/.meteor/meteor" ]; then curl https://install.meteor.com | sed s/--progress-bar/-sL/g | /bin/sh; fi
    - meteor --version
    - meteor npm install
    - mkdir -p /tmp/build
    - meteor build --server-only --server https://demo.goalify.chat /tmp/build
  artifacts:
    paths:
      - /tmp/build/*.gz

deploy_job:
  stage: deploy
  only:
    - goalify
    - test-gitlab-ci
  script:
    # install aws CLI to do S3 deploy
    - pip install awscli --upgrade --user

